(() => {
  // ---------- Estado ----------
  let selectedYear = new Date().getFullYear();
  let selectedMonthIndex = new Date().getMonth(); // 0-11
  let selectedFridayISO = null; // "YYYY-MM-DD"
  let selectedFridayLabel = null;

  let employeesCache = [];
  let leavesForSelectedFriday = [];

  // ---------- Elementos ----------
  const el = (id) => document.getElementById(id);

  // ---------- Utils ----------
  const pad2 = (n) => String(n).padStart(2, "0");

  function toISODateLocal(d) {
    // YYYY-MM-DD sem UTC (evita bug de fuso)
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  }

  function formatBR(iso) {
    // iso: YYYY-MM-DD
    const [y, m, d] = iso.split("-");
    return `${d}/${m}/${y}`;
  }

  function setText(id, text) {
    const node = el(id);
    if (node) node.textContent = String(text);
  }

  function showNode(id) {
    const node = el(id);
    if (!node) return;
    node.classList.remove("hidden");
    node.style.display = ""; // caso tenha inline display:none
  }

  function hideNode(id) {
    const node = el(id);
    if (!node) return;
    node.classList.add("hidden");
    node.style.display = "none"; // garante oculto
  }

  function openInfo(title, html) {
    setText("infoModalTitle", title);
    const content = el("infoModalContent");
    if (content) content.innerHTML = html;
    showNode("infoModal");
  }

  // ---------- Placeholders (n√£o deixar branco) ----------
  function setEmployeeTablePlaceholder(message) {
    const tbody = el("employeeTableBody");
    if (!tbody) return;
    tbody.innerHTML = `
      <tr>
        <td class="py-6 px-6 text-gray-500" colspan="5">
          ${message}
        </td>
      </tr>
    `;
  }

  function setTableTitle(text) {
    const t = el("tableTitle");
    if (t) t.textContent = text;
  }

  // ---------- Supabase (UMD j√° colocou window.supabase) ----------
  function sb() {
    if (!window.supabase) {
      throw new Error("Supabase n√£o encontrado. Verifique o script UMD e createClient no HTML.");
    }
    return window.supabase;
  }

  async function fetchEmployees() {
    const { data, error } = await sb()
      .from("employees")
      .select("*")
      .order("name", { ascending: true });

    if (error) throw error;
    return data ?? [];
  }

  async function fetchLeavesByDate(dateISO) {
    const { data, error } = await sb()
      .from("leaves")
      .select("*")
      .eq("date", dateISO);

    if (error) throw error;
    return data ?? [];
  }

  async function fetchPendingLeavesCount() {
    // Se voc√™ n√£o usa status, isso retorna 0 sem quebrar
    const { count, error } = await sb()
      .from("leaves")
      .select("*", { count: "exact", head: true })
      .eq("status", "pending");

    if (error) {
      // Se n√£o existir coluna status, n√£o derruba o app
      console.warn("fetchPendingLeavesCount:", error.message);
      return 0;
    }
    return count ?? 0;
  }

  // ---------- Sextas do m√™s ----------
  function getFridaysOfMonth(year, monthIndex) {
    const list = [];
    const d = new Date(year, monthIndex, 1);

    while (d.getMonth() === monthIndex) {
      if (d.getDay() === 5) list.push(new Date(d)); // 5 = sexta
      d.setDate(d.getDate() + 1);
    }
    return list;
  }

  function renderFridaysGrid() {
    const grid = el("fridaysGrid");
    if (!grid) return;

    const fridays = getFridaysOfMonth(selectedYear, selectedMonthIndex);
    grid.innerHTML = "";

    if (fridays.length === 0) {
      grid.innerHTML = `<div class="col-span-full text-gray-500">Nenhuma sexta encontrada.</div>`;
      return;
    }

    fridays.forEach((dateObj) => {
      const iso = toISODateLocal(dateObj);
      const label = `${pad2(dateObj.getDate())}/${pad2(dateObj.getMonth() + 1)}/${dateObj.getFullYear()}`;

      const isSelected = selectedFridayISO === iso;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className =
        "border rounded-xl p-4 text-left transition-all " +
        (isSelected
          ? "border-purple-600 ring-2 ring-purple-200 bg-purple-50"
          : "border-gray-200 hover:border-purple-300 hover:bg-gray-50");

      // Mostra um preview "X colaboradores" (sempre com base no cache)
      // OBS: isso N√ÉO filtra, √© s√≥ um preview.
      const previewCount = employeesCache.length;

      btn.innerHTML = `
        <div class="text-sm text-gray-500">Sexta-feira</div>
        <div class="text-lg font-semibold text-gray-900">${label}</div>
        <div class="mt-2 text-xs text-gray-500">üë• ${previewCount} colaboradores</div>
      `;

      btn.addEventListener("click", async () => {
        selectedFridayISO = iso;
        selectedFridayLabel = label;

        setTableTitle(`Colaboradores ‚Äî ${label}`);
        renderFridaysGrid(); // destaca selecionado

        await loadEmployeesForSelectedFriday();
      });

      grid.appendChild(btn);
    });
  }

  // ---------- Render Tabela ----------
  function renderEmployeeTable(employees, leaves) {
    const tbody = el("employeeTableBody");
    if (!tbody) return;

    if (!employees || employees.length === 0) {
      setEmployeeTablePlaceholder("Nenhum colaborador cadastrado.");
      return;
    }

    const leaveByEmployeeId = new Map();
    (leaves || []).forEach((l) => leaveByEmployeeId.set(l.employee_id, l));

    tbody.innerHTML = "";

    employees.forEach((emp) => {
      const leave = leaveByEmployeeId.get(emp.id);

      const status = leave ? (leave.status || "De folga") : "Trabalhando";
      const isLeave = !!leave && (leave.status !== "pending");
      const isPending = !!leave && (leave.status === "pending");

      const badgeClass = isPending
        ? "bg-yellow-100 text-yellow-700"
        : isLeave
          ? "bg-green-100 text-green-700"
          : "bg-orange-100 text-orange-700";

      const obs = leave?.notes ?? "-";

      const tr = document.createElement("tr");
      tr.className = "border-b border-gray-100 hover:bg-gray-50";

      tr.innerHTML = `
        <td class="py-4 px-6">
          <div class="font-medium text-gray-900">${emp.name ?? "Sem nome"}</div>
          <div class="text-xs text-gray-500">${emp.email ?? ""}</div>
        </td>
        <td class="py-4 px-6 text-gray-700">${emp.department ?? "-"}</td>
        <td class="py-4 px-6">
          <span class="px-3 py-1 rounded-full text-sm ${badgeClass}">
            ${isPending ? "Pendente" : (leave ? "De folga" : "Trabalhando")}
          </span>
        </td>
        <td class="py-4 px-6 text-gray-700">${obs}</td>
        <td class="py-4 px-6 text-center">
          <button class="px-3 py-2 rounded-lg border hover:bg-gray-100" type="button"
            data-emp-id="${emp.id}">
            ${leave ? "Ver" : "Marcar"}
          </button>
        </td>
      `;

      // A√ß√£o r√°pida: marcar folga do dia selecionado
      tr.querySelector("button")?.addEventListener("click", () => {
        if (!selectedFridayISO) {
          openInfo("Selecione uma sexta", "Selecione uma sexta-feira antes de registrar uma folga.");
          return;
        }
        openRegisterLeaveModal(emp.id);
      });

      tbody.appendChild(tr);
    });
  }

  // ---------- KPIs ----------
  function updateStats(employees, leaves) {
    setText("totalEmployees", employees.length);

    const leavesMap = new Map();
    (leaves || []).forEach((l) => leavesMap.set(l.employee_id, l));

    let onLeave = 0;
    let pending = 0;

    employees.forEach((e) => {
      const l = leavesMap.get(e.id);
      if (!l) return;
      if (l.status === "pending") pending += 1;
      else onLeave += 1;
    });

    const working = Math.max(0, employees.length - onLeave - pending);

    setText("onLeave", onLeave);
    setText("working", working);
    setText("pendingRequests", pending);
  }

  // ---------- Select do Modal Registrar ----------
  function populateLeaveEmployeeSelect(employees, preselectId = null) {
    const select = el("leaveEmployeeSelect");
    if (!select) return;

    select.innerHTML = `<option value="">Selecione...</option>`;

    employees.forEach((emp) => {
      const opt = document.createElement("option");
      opt.value = String(emp.id);
      opt.textContent = emp.name ?? "(Sem nome)";
      select.appendChild(opt);
    });

    if (preselectId) select.value = String(preselectId);
  }

  // ---------- Load principal ao selecionar sexta ----------
  async function loadEmployeesForSelectedFriday() {
    // Nunca deixar em branco
    if (!selectedFridayISO) {
      setEmployeeTablePlaceholder("Selecione uma sexta-feira para visualizar os colaboradores.");
      updateStats(employeesCache, []);
      return;
    }

    setEmployeeTablePlaceholder("Carregando...");

    try {
      // Employees SEMPRE do cache
      const leaves = await fetchLeavesByDate(selectedFridayISO);
      leavesForSelectedFriday = leaves;

      renderEmployeeTable(employeesCache, leavesForSelectedFriday);
      updateStats(employeesCache, leavesForSelectedFriday);

      // Atualiza pend√™ncias do header
      const pendingCount = await fetchPendingLeavesCount();
      setText("headerPendingCount", pendingCount);
    } catch (e) {
      console.error(e);
      setEmployeeTablePlaceholder("Erro ao carregar dados. Veja o console (F12) para detalhes.");
    }
  }

  // ---------- Init Ano/M√™s ----------
  function initYearMonthSelectors() {
    const yearSelect = el("yearSelect");
    const monthSelect = el("monthSelect");
    if (!yearSelect || !monthSelect) return;

    // anos: atual -2 at√© atual +3
    const nowY = new Date().getFullYear();
    yearSelect.innerHTML = "";
    for (let y = nowY - 2; y <= nowY + 3; y++) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      if (y === selectedYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }

    const months = [
      "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
      "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
    ];

    monthSelect.innerHTML = "";
    months.forEach((name, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx); // 0-11 (CORRETO)
      opt.textContent = name;
      if (idx === selectedMonthIndex) opt.selected = true;
      monthSelect.appendChild(opt);
    });

    yearSelect.addEventListener("change", async () => {
      selectedYear = Number(yearSelect.value);

      // reseta sele√ß√£o
      selectedFridayISO = null;
      selectedFridayLabel = null;
      setTableTitle("Colaboradores - Selecione uma sexta-feira");
      setEmployeeTablePlaceholder("Selecione uma sexta-feira para visualizar os colaboradores.");
      updateStats(employeesCache, []);

      renderFridaysGrid();
    });

    monthSelect.addEventListener("change", async () => {
      // value √© 0-11 (CORRETO)
      selectedMonthIndex = Number(monthSelect.value);

      // reseta sele√ß√£o
      selectedFridayISO = null;
      selectedFridayLabel = null;
      setTableTitle("Colaboradores - Selecione uma sexta-feira");
      setEmployeeTablePlaceholder("Selecione uma sexta-feira para visualizar os colaboradores.");
      updateStats(employeesCache, []);

      renderFridaysGrid();
    });
  }

  // ---------- Modais ----------
  window.closeInfoModal = () => hideNode("infoModal");

  window.showPasswordModal = () => {
    // aqui voc√™ pode validar senha se quiser
    const modal = el("passwordModal");
    if (!modal) return;
    modal.classList.remove("hidden");
    modal.style.display = "flex";
  };

  window.closePasswordModal = () => {
    const modal = el("passwordModal");
    if (!modal) return;
    modal.classList.add("hidden");
    modal.style.display = "none";
    const err = el("passwordError");
    if (err) err.classList.add("hidden");
    const inp = el("passwordInput");
    if (inp) inp.value = "";
  };

  function wirePasswordForm() {
    const form = el("passwordForm");
    if (!form) return;

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const pwd = el("passwordInput")?.value ?? "";
      // senha simples (troque como preferir)
      const ok = pwd === "admin123";

      if (!ok) {
        el("passwordError")?.classList.remove("hidden");
        return;
      }
      el("passwordError")?.classList.add("hidden");
      window.closePasswordModal();
      window.openEmployeesPage();
    });
  }

  window.openRegisterLeaveModal = (preselectEmployeeId = null) => {
    if (!selectedFridayISO) {
      openInfo("Selecione uma sexta", "Selecione uma sexta-feira antes de registrar uma folga.");
      return;
    }
    populateLeaveEmployeeSelect(employeesCache, preselectEmployeeId);

    const modal = el("registerLeaveModal");
    if (!modal) return;
    modal.classList.remove("hidden");
    modal.style.display = "flex";
  };

  window.closeRegisterLeaveModal = () => {
    const modal = el("registerLeaveModal");
    if (!modal) return;
    modal.classList.add("hidden");
    modal.style.display = "none";
    const sel = el("leaveEmployeeSelect");
    if (sel) sel.value = "";
  };

  function wireRegisterLeaveForm() {
    const form = el("registerLeaveForm");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!selectedFridayISO) {
        openInfo("Selecione uma sexta", "Selecione uma sexta-feira antes de registrar uma folga.");
        return;
      }

      const empId = el("leaveEmployeeSelect")?.value;
      if (!empId) {
        openInfo("Faltou selecionar", "Selecione um colaborador para registrar a folga.");
        return;
      }

      const notes = prompt("Observa√ß√µes (opcional):") || null;

      try {
        // Evita duplicar a mesma folga (mesmo employee_id + date)
        // Se voc√™ tiver unique constraint, melhor ainda.
        const { data: existing, error: exErr } = await sb()
          .from("leaves")
          .select("id")
          .eq("employee_id", empId)
          .eq("date", selectedFridayISO)
          .limit(1);

        if (exErr) throw exErr;

        if (existing && existing.length > 0) {
          openInfo("J√° existe", `Esse colaborador j√° tem registro de folga em ${formatBR(selectedFridayISO)}.`);
          window.closeRegisterLeaveModal();
          return;
        }

        const { error } = await sb()
          .from("leaves")
          .insert([{
            employee_id: empId,
            date: selectedFridayISO,
            status: "approved",
            notes
          }]);

        if (error) throw error;

        window.closeRegisterLeaveModal();
        openInfo("Folga registrada", `Folga registrada em <b>${formatBR(selectedFridayISO)}</b>.`);

        // Recarrega status do dia selecionado
        await loadEmployeesForSelectedFriday();
      } catch (err) {
        console.error(err);
        openInfo("Erro", `N√£o foi poss√≠vel registrar. Veja o console (F12).<br/><br/>${err.message ?? err}`);
      }
    });
  }

  // ---------- P√°gina Colaboradores ----------
  window.openEmployeesPage = async () => {
    showNode("employeesPage");
    await refreshEmployeesPage();
  };

  window.closeEmployeesPage = () => {
    hideNode("employeesPage");
  };

  window.showAddEmployeeForm = () => showNode("addEmployeeFormSection");
  window.hideAddEmployeeForm = () => hideNode("addEmployeeFormSection");

  async function refreshEmployeesPage() {
    // KPIs da p√°gina de colaboradores
    setText("totalEmployeesPage", employeesCache.length);

    const departments = new Set(
      employeesCache.map(e => (e.department ?? "").trim()).filter(Boolean)
    );
    setText("totalDepartments", departments.size);
    setText("todayRegistrations", 0); // (se quiser, d√° pra calcular com created_at)

    renderEmployeesListTable();
  }

  function renderEmployeesListTable() {
    const tbody = el("employeesListTable");
    if (!tbody) return;

    if (!employeesCache.length) {
      tbody.innerHTML = `
        <tr><td colspan="5" class="py-6 px-4 text-gray-500">Nenhum colaborador cadastrado.</td></tr>
      `;
      return;
    }

    tbody.innerHTML = "";

    employeesCache.forEach(emp => {
      const tr = document.createElement("tr");
      tr.className = "border-b hover:bg-gray-50";

      const createdAt = emp.created_at ? new Date(emp.created_at).toLocaleDateString("pt-BR") : "-";

      tr.innerHTML = `
        <td class="py-3 px-4 font-medium">${emp.name ?? "-"}</td>
        <td class="py-3 px-4">${emp.email ?? "-"}</td>
        <td class="py-3 px-4">${emp.department ?? "-"}</td>
        <td class="py-3 px-4 text-sm text-gray-600">${createdAt}</td>
        <td class="py-3 px-4 text-center">
          <button class="px-3 py-1 border rounded-lg hover:bg-gray-100" data-edit="${emp.id}">Editar</button>
          <button class="px-3 py-1 border rounded-lg hover:bg-gray-100" data-del="${emp.id}">Excluir</button>
        </td>
      `;

      tr.querySelector(`[data-edit="${emp.id}"]`)?.addEventListener("click", () => openEditEmployee(emp.id));
      tr.querySelector(`[data-del="${emp.id}"]`)?.addEventListener("click", () => openDeleteEmployee(emp.id));

      tbody.appendChild(tr);
    });
  }

  // ---------- Adicionar colaborador ----------
  function wireAddEmployeeForm() {
    const form = el("addEmployeeFormPage");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = el("employeeNamePage")?.value?.trim();
      const email = el("employeeEmailPage")?.value?.trim();
      const department = el("employeeDepartmentPage")?.value?.trim() || null;

      if (!name || !email) {
        openInfo("Campos obrigat√≥rios", "Nome e e-mail s√£o obrigat√≥rios.");
        return;
      }

      try {
        const { error } = await sb().from("employees").insert([{ name, email, department }]);
        if (error) throw error;

        // limpa
        el("employeeNamePage").value = "";
        el("employeeEmailPage").value = "";
        // recarrega cache
        employeesCache = await fetchEmployees();

        await refreshEmployeesPage();
        renderFridaysGrid(); // atualiza preview
        populateLeaveEmployeeSelect(employeesCache); // modal
        openInfo("Salvo", "Colaborador cadastrado com sucesso.");
      } catch (err) {
        console.error(err);
        openInfo("Erro", `N√£o foi poss√≠vel salvar. Veja o console (F12).<br/><br/>${err.message ?? err}`);
      }
    });
  }

  // ---------- Editar/Excluir ----------
  let editingEmployeeId = null;
  let deletingEmployeeId = null;

  function openEditEmployee(empId) {
    const emp = employeesCache.find(e => String(e.id) === String(empId));
    if (!emp) return;

    editingEmployeeId = empId;

    el("editEmployeeName").value = emp.name ?? "";
    el("editEmployeeEmail").value = emp.email ?? "";
    el("editEmployeeDepartment").value = emp.department ?? "Comercial";

    // custom dept
    const customInput = el("customDepartmentEdit");
    if (customInput) customInput.classList.add("hidden");

    showNode("editEmployeeModal");
  }

  window.closeEditEmployeeModal = () => {
    editingEmployeeId = null;
    hideNode("editEmployeeModal");
  };

  function wireEditEmployeeForm() {
    const sel = el("editEmployeeDepartment");
    const custom = el("customDepartmentEdit");

    sel?.addEventListener("change", () => {
      if (sel.value === "custom") {
        custom?.classList.remove("hidden");
        custom?.focus();
      } else {
        custom?.classList.add("hidden");
      }
    });

    const form = el("editEmployeeForm");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!editingEmployeeId) return;

      const name = el("editEmployeeName")?.value?.trim();
      const email = el("editEmployeeEmail")?.value?.trim();

      let department = el("editEmployeeDepartment")?.value?.trim() || null;
      if (department === "custom") {
        department = el("customDepartmentEdit")?.value?.trim() || null;
      }

      if (!name || !email) {
        openInfo("Campos obrigat√≥rios", "Nome e e-mail s√£o obrigat√≥rios.");
        return;
      }

      try {
        const { error } = await sb()
          .from("employees")
          .update({ name, email, department })
          .eq("id", editingEmployeeId);

        if (error) throw error;

        employeesCache = await fetchEmployees();

        await refreshEmployeesPage();
        renderFridaysGrid();
        populateLeaveEmployeeSelect(employeesCache);
        window.closeEditEmployeeModal();
        openInfo("Atualizado", "Colaborador atualizado com sucesso.");
      } catch (err) {
        console.error(err);
        openInfo("Erro", `N√£o foi poss√≠vel atualizar. Veja o console (F12).<br/><br/>${err.message ?? err}`);
      }
    });
  }

  function openDeleteEmployee(empId) {
    const emp = employeesCache.find(e => String(e.id) === String(empId));
    if (!emp) return;

    deletingEmployeeId = empId;
    const box = el("deleteEmployeeInfo");
    if (box) {
      box.innerHTML = `
        <div class="text-sm text-gray-700">
          Tem certeza que deseja excluir <b>${emp.name ?? "-"}</b>?
          <div class="text-xs text-gray-500 mt-1">${emp.email ?? ""}</div>
        </div>
      `;
    }

    showNode("deleteConfirmModal");
  }

  window.closeDeleteConfirmModal = () => {
    deletingEmployeeId = null;
    hideNode("deleteConfirmModal");
  };

  window.executeConfirmedDeletion = async () => {
    if (!deletingEmployeeId) return;

    try {
      // Se existir leaves com FK, pode dar erro (dependendo do seu schema).
      // Se quiser, posso te passar um delete em cascata controlado.
      const { error } = await sb().from("employees").delete().eq("id", deletingEmployeeId);
      if (error) throw error;

      employeesCache = await fetchEmployees();

      await refreshEmployeesPage();
      renderFridaysGrid();
      populateLeaveEmployeeSelect(employeesCache);
      window.closeDeleteConfirmModal();
      openInfo("Exclu√≠do", "Colaborador exclu√≠do com sucesso.");

      // Recarrega tabela principal se estiver numa sexta selecionada
      await loadEmployeesForSelectedFriday();
    } catch (err) {
      console.error(err);
      openInfo("Erro", `N√£o foi poss√≠vel excluir. Veja o console (F12).<br/><br/>${err.message ?? err}`);
    }
  };

  // ---------- Views do Header (placeholders) ----------
  window.showAllLeaves = () => {
    openInfo("Em desenvolvimento", "Aqui voc√™ pode listar todas as folgas (hist√≥rico). Se quiser, eu implemento completo.");
  };

  window.showPendingRequests = () => {
    openInfo("Em desenvolvimento", "Aqui voc√™ pode listar pend√™ncias (status = pending). Se quiser, eu implemento completo.");
  };

  // ---------- Bootstrap ----------
  async function bootstrap() {
    try {
      // Carrega colaboradores 1x (sempre)
      employeesCache = await fetchEmployees();

      // Atualiza KPIs base (sem sexta selecionada)
      updateStats(employeesCache, []);

      // Popular select do modal sempre (n√£o depende de m√™s)
      populateLeaveEmployeeSelect(employeesCache);

      // Inicializa selectors e grid
      initYearMonthSelectors();
      renderFridaysGrid();

      // Placeholder inicial (n√£o branco)
      setEmployeeTablePlaceholder("Selecione uma sexta-feira para visualizar os colaboradores.");
      setTableTitle("Colaboradores - Selecione uma sexta-feira");

      // Header pend√™ncias
      const pendingCount = await fetchPendingLeavesCount();
      setText("headerPendingCount", pendingCount);

      // P√°gina colaboradores
      await refreshEmployeesPage();
    } catch (err) {
      console.error(err);
      openInfo(
        "Erro ao iniciar",
        `N√£o consegui carregar os dados do Supabase.<br/><br/>
         <b>Dica:</b> abra o console (F12) e veja o erro.<br/><br/>
         ${err.message ?? err}`
      );
      setEmployeeTablePlaceholder("Erro ao carregar. Veja o console (F12).");
    }
  }

  // ---------- Wire forms ----------
  document.addEventListener("DOMContentLoaded", () => {
    wirePasswordForm();
    wireRegisterLeaveForm();
    wireAddEmployeeForm();
    wireEditEmployeeForm();
    bootstrap();
  });
})();
